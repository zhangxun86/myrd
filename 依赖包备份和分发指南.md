# 依赖包备份和分发指南

## 📦 依赖包管理概述

本指南详细说明RustDesk Android项目的所有依赖包管理方案，确保新同事能够快速获取和配置所有必要的依赖项。

---

## 🎯 依赖包分发方案

### 方案一：GitHub仓库获取 (推荐⭐⭐⭐⭐⭐)
**仓库信息**:
- 地址: https://github.com/zhangxun86/myrd.git
- 访问方式: 公开仓库

**使用方法**:
```bash
# 克隆仓库
git clone https://github.com/zhangxun86/myrd.git
cd myrd

# 按照指南安装环境和依赖
# 详见《新同事项目接手完整指南.md》
```

**优势**:
- ✅ 始终获取最新代码版本
- ✅ 支持版本控制和协作开发
- ✅ 包含完整的指南文档

---

## 📋 依赖包详细清单

### Flutter依赖包 (37个)
**核心框架依赖**:
```yaml
flutter: sdk
flutter_localizations: sdk
flutter_rust_bridge: "1.80.1"
ffi: ^2.1.0
```

**UI和功能依赖**:
```yaml
provider: ^6.0.5
tuple: ^2.0.0
wakelock_plus: ^1.1.3
package_info_plus: ^4.2.0
url_launcher: ^6.3.1
toggle_switch: ^2.1.0
settings_ui: ^2.0.2
flutter_breadcrumb: ^1.0.1
http: ^1.1.0
image_picker: ^1.1.2
image: ^4.0.17
back_button_interceptor: ^6.0.1
```

**特殊Git依赖 (关键！)**:
```yaml
dash_chat_2:
  git:
    url: https://github.com/rustdesk-org/Dash-Chat-2

window_manager:
  git:
    url: https://github.com/rustdesk-org/window_manager

desktop_multi_window:
  git:
    url: https://github.com/rustdesk-org/rustdesk_desktop_multi_window

uni_links:
  git:
    url: https://github.com/rustdesk-org/uni_links
    path: uni_links
    ref: f416118d843a7e9ed117c7bb7bdc2deda5a9e86f

texture_rgba_renderer:
  git:
    url: https://github.com/rustdesk-org/flutter_texture_rgba_renderer
    ref: 42797e0f03141dc2b585f76c64a13974508058b4

flutter_gpu_texture_renderer:
  git:
    url: https://github.com/rustdesk-org/flutter_gpu_texture_renderer
    ref: 08a471bb8ceccdd50483c81cdfa8b81b07b14b87

dynamic_layouts:
  git:
    url: https://github.com/rustdesk-org/dynamic_layouts.git
    ref: 24cb88413fa5181d949ddacbb30a65d5c459e7d9

window_size:
  git:
    url: https://github.com/google/flutter-desktop-embedding.git
    path: plugins/window_size
    ref: eb3964990cf19629c89ff8cb4a37640c7b3d5601
```

### Rust依赖包 (Cargo.toml)
**核心依赖**:
- `tokio` - 异步运行时
- `serde` - 序列化/反序列化
- `flutter_rust_bridge` - Flutter桥接
- `uuid` - UUID生成
- `anyhow` - 错误处理

**平台特定依赖**:
- Android NDK相关crate
- JNI桥接库
- 系统调用相关库

---

## 🌐 网络配置和镜像源

### 美国服务器网络配置 (推荐)
**直连配置** (无需代理):
```bash
# 使用默认官方源
unset PUB_HOSTED_URL
unset FLUTTER_STORAGE_BASE_URL

# Rust使用官方源
rm ~/.cargo/config.toml  # 移除镜像配置（如果存在）
```

**优势**: 
- ✅ 网络速度快，无需代理
- ✅ 包版本最新，兼容性好
- ✅ 连接稳定，少见超时问题

### 中国大陆网络备用配置
**Flutter镜像源**:
```bash
export PUB_HOSTED_URL=https://pub.flutter-io.cn
export FLUTTER_STORAGE_BASE_URL=https://storage.flutter-io.cn
```

**Rust镜像源配置**:
```bash
mkdir -p ~/.cargo
cat > ~/.cargo/config.toml << 'EOF'
[source.crates-io]
registry = "https://github.com/rust-lang/crates.io-index"
replace-with = 'mirror'

[source.mirror]
registry = "https://mirrors.ustc.edu.cn/crates.io-index"
EOF
```

---

## 🔧 依赖问题解决方案

### 常见依赖问题及解决方案

#### 1. Flutter依赖冲突
**问题**: `version solving failed`
```bash
# 解决方案：
flutter clean
rm -rf .dart_tool/
rm pubspec.lock
flutter pub get
```

#### 2. Git依赖获取失败
**问题**: `git clone failed` 或网络超时
```bash
# 解决方案1：检查网络连接
ping github.com

# 解决方案2：使用HTTPS替代SSH
git config --global url."https://github.com/".insteadOf "git@github.com:"

# 解决方案3：增加Git超时时间
git config --global http.lowSpeedLimit 0
git config --global http.lowSpeedTime 999999
```

#### 3. Rust依赖编译失败
**问题**: `failed to compile package`
```bash
# 解决方案：
cargo clean
cargo update  # 更新依赖版本
cargo build --release --target aarch64-linux-android -v  # 详细输出
```

#### 4. NDK工具链问题
**问题**: `linker not found` 或 `cc failed`
```bash
# 解决方案：
export NDK_HOME=$ANDROID_HOME/ndk/25.1.8937393
export PATH=$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH

# 验证工具链
$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android33-clang --version
```

#### 5. Kotlin编译缓存问题 (重要！)
**问题**: Kotlin增量编译缓存冲突
```bash
# 解决方案（按项目规范）：
# 1. 终止所有相关进程
pkill -f gradle
pkill -f kotlin
pkill -f java

# 2. 完全清理缓存
rm -rf build ~/.gradle /tmp/kotlin* /tmp/gradle*
flutter clean

# 3. 配置gradle.properties
echo "kotlin.incremental=false" >> flutter/android/gradle.properties
echo "org.gradle.daemon=false" >> flutter/android/gradle.properties
echo "org.gradle.parallel=false" >> flutter/android/gradle.properties
echo "org.gradle.jvmargs=-Xmx2048m" >> flutter/android/gradle.properties
```

---

## 📊 依赖包大小和下载时间预估

### Flutter依赖包
| 包类型 | 数量 | 预估大小 | 下载时间 (美国服务器) |
|--------|------|----------|----------------------|
| 核心SDK包 | 2 | ~50MB | 30-60秒 |
| 第三方包 | 25 | ~100MB | 1-2分钟 |
| Git依赖包 | 10 | ~200MB | 2-3分钟 |
| **总计** | **37** | **~350MB** | **3-5分钟** |

### Rust依赖包
| 包类型 | 预估大小 | 下载时间 (美国服务器) |
|--------|----------|----------------------|
| 核心crate | ~100MB | 1-2分钟 |
| 平台相关 | ~50MB | 30-60秒 |
| **总计** | **~150MB** | **2-3分钟** |

### 总计依赖
- **总下载量**: ~500MB
- **总时间**: 5-8分钟 (美国服务器网络良好时)
- **磁盘占用**: ~1.5GB (包含编译缓存)

---

## 🚀 快速依赖配置脚本

### 自动化依赖安装脚本
```
#!/bin/bash
# 文件名: setup_dependencies.sh

set -e  # 遇到错误立即退出

echo "🚀 开始配置RustDesk Android项目依赖..."

# 1. 检查环境
echo "📋 检查基础环境..."
java -version || { echo "❌ Java未安装"; exit 1; }
flutter --version || { echo "❌ Flutter未安装"; exit 1; }
rustc --version || { echo "❌ Rust未安装"; exit 1; }

# 2. 清理旧缓存
echo "🧹 清理旧缓存..."
flutter clean
cargo clean
rm -rf .dart_tool/

# 3. Flutter依赖
echo "📦 获取Flutter依赖..."
cd flutter
flutter pub get
cd ..

# 4. Rust依赖
echo "🦀 构建Rust依赖..."
cargo build --release --target aarch64-linux-android

# 5. 复制库文件
echo "📋 复制原生库..."
mkdir -p flutter/android/app/src/main/jniLibs/arm64-v8a/
cp target/aarch64-linux-android/release/librustdesk.so flutter/android/app/src/main/jniLibs/arm64-v8a/

# 6. 验证
echo "✅ 验证依赖完整性..."
ls -la target/aarch64-linux-android/release/librustdesk.so
ls -la flutter/.dart_tool/

echo "🎉 依赖配置完成！可以开始构建APK了。"
```

**使用方法**:
```bash
chmod +x setup_dependencies.sh
./setup_dependencies.sh
```

---

## 🔄 依赖包版本管理

### 版本锁定策略
**Flutter依赖版本锁定**:
- 使用`pubspec.lock`文件锁定精确版本
- 重要依赖使用固定版本号，如`flutter_rust_bridge: "1.80.1"`

**Rust依赖版本锁定**:
- 使用`Cargo.lock`文件锁定版本
- 关键crate使用精确版本指定

### 版本升级策略
⚠️ **重要**: 不建议随意升级依赖版本，特别是以下关键依赖：
- `flutter_rust_bridge`: 必须保持1.80.1
- `ffi`: 影响底层调用
- Git依赖包的commit hash: 已经过验证的稳定版本

---

## 📞 依赖支持和故障排除

### 获取帮助的渠道
1. **项目文档**: 查看本指南和接手指南
2. **日志分析**: 仔细阅读错误日志
3. **官方文档**: Flutter、Rust官方文档
4. **社区支持**: GitHub Issues、Stack Overflow

### 依赖问题诊断清单
遇到依赖问题时，按以下顺序检查：

- [ ] 网络连接是否正常
- [ ] 环境变量是否正确设置
- [ ] 磁盘空间是否充足 (至少5GB)
- [ ] 权限是否正确 (所有目录可读写)
- [ ] 版本是否匹配 (Java 17, Flutter 3.24.5等)
- [ ] 缓存是否损坏 (尝试清理缓存)
- [ ] Kotlin编译配置是否正确 (检查gradle.properties)

### 紧急恢复方案
如果依赖完全损坏：
1. **重新克隆项目**: 从GitHub获取全新副本
2. **重新安装环境**: 按照完整指南重新配置
3. **分步骤验证**: 每个环节都验证成功后再继续

---

**文档版本**: v2.1  
**最后更新**: 2024-09-14  
**维护者**: RustDesk开发团队  
**适用环境**: Linux服务器，美国网络环境