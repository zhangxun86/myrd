# RustDesk Android 项目完整接手指南

## 📋 项目概述
- **项目名称**: RustDesk Android远程桌面应用
- **架构**: Flutter + Rust 混合开发
- **目标平台**: Android (arm64-v8a)
- **当前版本**: 1.4.2+60
- **服务器环境**: 美国服务器 (无需代理)

## 🚨 重要提醒
> **必读！！！** 本指南包含完整的从零开始的环境搭建流程，任何步骤都不可省略！
> 请严格按照顺序执行，遇到问题立即停止并查看问题解决部分。

---

## 📁 1. 获取项目代码

### 1.1 从GitHub仓库获取最新代码
```bash
# 克隆项目仓库
git clone https://github.com/zhangxun86/myrd.git
cd myrd

# 验证项目结构
ls -la
# 应该看到: flutter/ res/ src/ target/ Cargo.toml build.rs 等目录和文件
```

### 1.2 项目结构说明
```
myrd/
├── flutter/                    # Flutter应用主目录
│   ├── lib/                   # Dart源代码
│   │   ├── generated_bridge.dart  # 重要：Rust桥接文件
│   │   ├── models/            # 数据模型
│   │   └── ...
│   ├── android/               # Android配置
│   └── pubspec.yaml          # Flutter依赖配置
├── src/                       # Rust源代码
├── target/                    # Rust编译输出
├── Cargo.toml                 # Rust项目配置
└── build.rs                   # 构建脚本
```

---

## ⚙️ 2. 环境安装配置 (极其重要！)

### 2.1 系统要求
- **操作系统**: CentOS 7/8 或 Ubuntu 18+
- **内存**: 最少4GB，推荐8GB+
- **磁盘**: 至少20GB可用空间
- **网络**: 美国服务器环境，无需代理

### 2.2 Java 17 环境安装
```bash
# 安装OpenJDK 17 (重要：必须是17，不能是8或11)
sudo yum install -y java-17-openjdk java-17-openjdk-devel

# 验证安装
java -version
# 输出应该包含: openjdk version "17.x.x"

# 设置JAVA_HOME环境变量
echo 'export JAVA_HOME=/usr/lib/jvm/java-17-openjdk' >> ~/.bashrc
echo 'export PATH=$JAVA_HOME/bin:$PATH' >> ~/.bashrc
source ~/.bashrc

# 验证环境变量
echo $JAVA_HOME
# 应该输出: /usr/lib/jvm/java-17-openjdk
```

### 2.3 Android SDK 安装
```bash
# 创建Android SDK目录
mkdir -p /root/android-sdk
cd /root/android-sdk

# 下载Android命令行工具
wget https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
unzip commandlinetools-linux-11076708_latest.zip
mkdir -p cmdline-tools/latest
mv cmdline-tools/* cmdline-tools/latest/ 2>/dev/null || true

# 设置Android环境变量
echo 'export ANDROID_HOME=/root/android-sdk' >> ~/.bashrc
echo 'export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH' >> ~/.bashrc
source ~/.bashrc

# 安装必要的Android组件
sdkmanager --install "platform-tools"
sdkmanager --install "platforms;android-33"
sdkmanager --install "build-tools;33.0.2"
sdkmanager --install "ndk;25.1.8937393"

# 验证安装
adb --version
# 应该显示Android Debug Bridge版本信息
```

### 2.4 Flutter 3.24.5 安装
```bash
# 下载Flutter 3.24.5
cd /root
wget https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/flutter_linux_3.24.5-stable.tar.xz
tar xf flutter_linux_3.24.5-stable.tar.xz

# 设置Flutter环境变量
echo 'export PATH=/root/flutter/bin:$PATH' >> ~/.bashrc
source ~/.bashrc

# 验证Flutter安装
flutter --version
# 应该显示: Flutter 3.24.5

# 配置Flutter
flutter config --no-analytics
flutter doctor --android-licenses  # 接受所有许可协议

# 检查Flutter环境
flutter doctor
# 确保Android相关检查都通过
```

### 2.5 Rust 环境安装
```bash
# 安装Rust
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
source ~/.bashrc

# 验证Rust安装
rustc --version
cargo --version

# 添加Android目标
rustup target add aarch64-linux-android

# 验证目标安装
rustup target list --installed | grep android
# 应该看到: aarch64-linux-android
```

---

## 📦 3. 依赖包管理 (核心重点！)

### 3.1 Flutter依赖配置
```bash
cd myrd/flutter

# 清理缓存
flutter clean
rm -rf .dart_tool/
rm -rf build/

# 获取Flutter依赖
flutter pub get

# 如果遇到网络问题，设置镜像：
export PUB_HOSTED_URL=https://pub.flutter-io.cn
export FLUTTER_STORAGE_BASE_URL=https://storage.flutter-io.cn
flutter pub get
```

### 3.2 Rust依赖配置
```bash
cd myrd

# 清理Rust缓存
cargo clean

# 构建Rust依赖
cargo build --release --target aarch64-linux-android

# 如果遇到网络问题，配置Rust镜像：
mkdir -p ~/.cargo
cat > ~/.cargo/config.toml << 'EOF'
[source.crates-io]
registry = "https://github.com/rust-lang/crates.io-index"
replace-with = 'mirror'

[source.mirror]
registry = "https://mirrors.ustc.edu.cn/crates.io-index"
EOF
```

---

## 🔨 4. 构建流程

### 4.1 预构建检查
```bash
cd myrd/flutter

# 环境检查
flutter doctor -v
# 确保所有检查都通过

# 项目配置检查
flutter analyze
# 应该没有严重错误

# 依赖检查
flutter pub deps
# 确认所有依赖都正确解析
```

### 4.2 Rust库编译
```bash
cd myrd

# 清理之前的构建
cargo clean

# 编译Rust库
cargo build --release --target aarch64-linux-android

# 验证编译结果
ls -la target/aarch64-linux-android/release/librustdesk.so
# 文件应该存在且大小约400-500KB

# 复制到Flutter项目
mkdir -p flutter/android/app/src/main/jniLibs/arm64-v8a/
cp target/aarch64-linux-android/release/librustdesk.so flutter/android/app/src/main/jniLibs/arm64-v8a/
```

### 4.3 Flutter APK构建
```bash
cd myrd/flutter

# 清理Flutter缓存
flutter clean
flutter pub get

# 构建APK (使用项目记忆中的具体命令)
export PATH="/root/flutter/bin:$PATH"
flutter build apk --release --no-shrink --build-name=1.4.2 --build-number=60

# 验证APK
ls -la build/app/outputs/flutter-apk/
# 应该看到生成的APK文件
```

---

## ⚠️ 5. 常见问题及解决方案

### 5.1 Java版本问题
**问题**: `Unsupported Java version` 或版本冲突
```bash
# 解决方案：切换到Java 17
sudo alternatives --config java  # 选择Java 17
export JAVA_HOME=/usr/lib/jvm/java-17-openjdk
java -version  # 验证版本
```

### 5.2 Flutter依赖问题
**问题**: `pub get failed` 或依赖解析错误
```bash
# 解决方案：
flutter clean
rm -rf ~/.pub-cache/  # 清理全局缓存
rm -rf .dart_tool/
flutter pub cache repair  # 修复缓存
flutter pub get
```

### 5.3 Kotlin编译问题
**问题**: Kotlin缓存冲突或编译错误
```bash
# 解决方案（按内存知识）：
# 1. 终止所有相关进程
pkill -f gradle
pkill -f kotlin
pkill -f java

# 2. 完全清理缓存
rm -rf build ~/.gradle /tmp/kotlin* /tmp/gradle*
flutter clean

# 3. 禁用Kotlin增量编译 - 在gradle.properties中添加
echo "kotlin.incremental=false" >> flutter/android/gradle.properties
echo "org.gradle.daemon=false" >> flutter/android/gradle.properties
echo "org.gradle.parallel=false" >> flutter/android/gradle.properties

# 4. 增加内存分配
echo "org.gradle.jvmargs=-Xmx2048m" >> flutter/android/gradle.properties
```

### 5.4 Android许可协议问题
```bash
# 解决方案：
flutter doctor --android-licenses
# 输入 'y' 接受所有许可协议
```

### 5.5 Rust编译错误
```bash
# 解决方案：安装必要的构建工具
yum install -y gcc gcc-c++ make

# 设置NDK路径
export NDK_HOME=$ANDROID_HOME/ndk/25.1.8937393
export PATH=$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
```

---

## 🔍 6. 重要文件详解

### 6.1 generated_bridge.dart
- **位置**: `flutter/lib/generated_bridge.dart`
- **作用**: Flutter与Rust的桥接文件
- **重要性**: ⭐⭐⭐⭐⭐ **绝对不可修改！** 已解决PlatformFFI冲突问题

### 6.2 pubspec.yaml
- **位置**: `flutter/pubspec.yaml`
- **作用**: Flutter项目依赖配置
- **关键依赖**: 
  - `flutter_rust_bridge: "1.80.1"`
  - `ffi: ^2.1.0`

---

## 📊 7. 构建验证

### 7.1 构建成功标志
```bash
# Rust库编译成功
ls -la target/aarch64-linux-android/release/librustdesk.so
# 文件大小应该在400-500KB

# Flutter APK构建成功
ls -la flutter/build/app/outputs/flutter-apk/app-release.apk
# 文件大小应该在50-100MB

# 日志中应该看到
# "Built build/app/outputs/flutter-apk/app-release.apk"
```

---

## 🎯 8. 快速开始检查清单

新同事接手项目时，请按照以下清单逐项检查：

- [ ] 1. 克隆项目代码成功
- [ ] 2. Java 17 安装并设置环境变量
- [ ] 3. Android SDK 安装并通过flutter doctor检查
- [ ] 4. Flutter 3.24.5 安装并可正常运行
- [ ] 5. Rust 环境安装并添加Android目标
- [ ] 6. 项目依赖获取成功 (flutter pub get)
- [ ] 7. Rust库编译成功 (librustdesk.so存在)
- [ ] 8. Flutter分析通过 (flutter analyze)
- [ ] 9. APK构建成功
- [ ] 10. APK功能验证通过

**每一项都必须✅才能进行下一步！**

---

## 🚨 特别注意事项

1. **包名规范**: Android包名必须符合Java标识符规范，不能包含数字开头的部分
2. **Kotlin配置**: 必须禁用增量编译和并行执行避免缓存冲突
3. **内存配置**: Gradle需要至少2GB内存进行编译
4. **文件权限**: 确保所有目录具有正确的读写权限

---

最后更新时间: 2024-09-14  
文档版本: v2.1  
维护者: RustDesk开发团队# RustDesk Android 项目完整接手指南

## 📋 项目概述
- **项目名称**: RustDesk Android远程桌面应用
- **架构**: Flutter + Rust 混合开发
- **目标平台**: Android (arm64-v8a)
- **当前版本**: 1.4.2+60
- **服务器环境**: 美国服务器 (无需代理)

## 🚨 重要提醒
> **必读！！！** 本指南包含完整的从零开始的环境搭建流程，任何步骤都不可省略！
> 请严格按照顺序执行，遇到问题立即停止并查看问题解决部分。

---

## 📁 1. 获取项目代码

### 1.1 从GitHub仓库获取最新代码
```bash
# 克隆项目仓库
git clone https://github.com/zhangxun86/myrd.git
cd myrd

# 验证项目结构
ls -la
# 应该看到: flutter/ res/ src/ target/ Cargo.toml build.rs 等目录和文件
```

### 1.2 项目结构说明
```
myrd/
├── flutter/                    # Flutter应用主目录
│   ├── lib/                   # Dart源代码
│   │   ├── generated_bridge.dart  # 重要：Rust桥接文件
│   │   ├── models/            # 数据模型
│   │   └── ...
│   ├── android/               # Android配置
│   └── pubspec.yaml          # Flutter依赖配置
├── src/                       # Rust源代码
├── target/                    # Rust编译输出
├── Cargo.toml                 # Rust项目配置
└── build.rs                   # 构建脚本
```

---

## ⚙️ 2. 环境安装配置 (极其重要！)

### 2.1 系统要求
- **操作系统**: CentOS 7/8 或 Ubuntu 18+
- **内存**: 最少4GB，推荐8GB+
- **磁盘**: 至少20GB可用空间
- **网络**: 美国服务器环境，无需代理

### 2.2 Java 17 环境安装
```bash
# 安装OpenJDK 17 (重要：必须是17，不能是8或11)
sudo yum install -y java-17-openjdk java-17-openjdk-devel

# 验证安装
java -version
# 输出应该包含: openjdk version "17.x.x"

# 设置JAVA_HOME环境变量
echo 'export JAVA_HOME=/usr/lib/jvm/java-17-openjdk' >> ~/.bashrc
echo 'export PATH=$JAVA_HOME/bin:$PATH' >> ~/.bashrc
source ~/.bashrc

# 验证环境变量
echo $JAVA_HOME
# 应该输出: /usr/lib/jvm/java-17-openjdk
```

### 2.3 Android SDK 安装
```bash
# 创建Android SDK目录
mkdir -p /root/android-sdk
cd /root/android-sdk

# 下载Android命令行工具
wget https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
unzip commandlinetools-linux-11076708_latest.zip
mkdir -p cmdline-tools/latest
mv cmdline-tools/* cmdline-tools/latest/ 2>/dev/null || true

# 设置Android环境变量
echo 'export ANDROID_HOME=/root/android-sdk' >> ~/.bashrc
echo 'export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH' >> ~/.bashrc
source ~/.bashrc

# 安装必要的Android组件
sdkmanager --install "platform-tools"
sdkmanager --install "platforms;android-33"
sdkmanager --install "build-tools;33.0.2"
sdkmanager --install "ndk;25.1.8937393"

# 验证安装
adb --version
# 应该显示Android Debug Bridge版本信息
```

### 2.4 Flutter 3.24.5 安装
```bash
# 下载Flutter 3.24.5
cd /root
wget https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/flutter_linux_3.24.5-stable.tar.xz
tar xf flutter_linux_3.24.5-stable.tar.xz

# 设置Flutter环境变量
echo 'export PATH=/root/flutter/bin:$PATH' >> ~/.bashrc
source ~/.bashrc

# 验证Flutter安装
flutter --version
# 应该显示: Flutter 3.24.5

# 配置Flutter
flutter config --no-analytics
flutter doctor --android-licenses  # 接受所有许可协议

# 检查Flutter环境
flutter doctor
# 确保Android相关检查都通过
```

### 2.5 Rust 环境安装
```bash
# 安装Rust
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
source ~/.bashrc

# 验证Rust安装
rustc --version
cargo --version

# 添加Android目标
rustup target add aarch64-linux-android

# 验证目标安装
rustup target list --installed | grep android
# 应该看到: aarch64-linux-android
```

---

## 📦 3. 依赖包管理 (核心重点！)

### 3.1 Flutter依赖配置
```bash
cd myrd/flutter

# 清理缓存
flutter clean
rm -rf .dart_tool/
rm -rf build/

# 获取Flutter依赖
flutter pub get

# 如果遇到网络问题，设置镜像：
export PUB_HOSTED_URL=https://pub.flutter-io.cn
export FLUTTER_STORAGE_BASE_URL=https://storage.flutter-io.cn
flutter pub get
```

### 3.2 Rust依赖配置
```bash
cd myrd

# 清理Rust缓存
cargo clean

# 构建Rust依赖
cargo build --release --target aarch64-linux-android

# 如果遇到网络问题，配置Rust镜像：
mkdir -p ~/.cargo
cat > ~/.cargo/config.toml << 'EOF'
[source.crates-io]
registry = "https://github.com/rust-lang/crates.io-index"
replace-with = 'mirror'

[source.mirror]
registry = "https://mirrors.ustc.edu.cn/crates.io-index"
EOF
```

---

## 🔨 4. 构建流程

### 4.1 预构建检查
```bash
cd myrd/flutter

# 环境检查
flutter doctor -v
# 确保所有检查都通过

# 项目配置检查
flutter analyze
# 应该没有严重错误

# 依赖检查
flutter pub deps
# 确认所有依赖都正确解析
```

### 4.2 Rust库编译
```bash
cd myrd

# 清理之前的构建
cargo clean

# 编译Rust库
cargo build --release --target aarch64-linux-android

# 验证编译结果
ls -la target/aarch64-linux-android/release/librustdesk.so
# 文件应该存在且大小约400-500KB

# 复制到Flutter项目
mkdir -p flutter/android/app/src/main/jniLibs/arm64-v8a/
cp target/aarch64-linux-android/release/librustdesk.so flutter/android/app/src/main/jniLibs/arm64-v8a/
```

### 4.3 Flutter APK构建
```bash
cd myrd/flutter

# 清理Flutter缓存
flutter clean
flutter pub get

# 构建APK (使用项目记忆中的具体命令)
export PATH="/root/flutter/bin:$PATH"
flutter build apk --release --no-shrink --build-name=1.4.2 --build-number=60

# 验证APK
ls -la build/app/outputs/flutter-apk/
# 应该看到生成的APK文件
```

---

## ⚠️ 5. 常见问题及解决方案

### 5.1 Java版本问题
**问题**: `Unsupported Java version` 或版本冲突
```bash
# 解决方案：切换到Java 17
sudo alternatives --config java  # 选择Java 17
export JAVA_HOME=/usr/lib/jvm/java-17-openjdk
java -version  # 验证版本
```

### 5.2 Flutter依赖问题
**问题**: `pub get failed` 或依赖解析错误
```bash
# 解决方案：
flutter clean
rm -rf ~/.pub-cache/  # 清理全局缓存
rm -rf .dart_tool/
flutter pub cache repair  # 修复缓存
flutter pub get
```

### 5.3 Kotlin编译问题
**问题**: Kotlin缓存冲突或编译错误
```bash
# 解决方案（按内存知识）：
# 1. 终止所有相关进程
pkill -f gradle
pkill -f kotlin
pkill -f java

# 2. 完全清理缓存
rm -rf build ~/.gradle /tmp/kotlin* /tmp/gradle*
flutter clean

# 3. 禁用Kotlin增量编译 - 在gradle.properties中添加
echo "kotlin.incremental=false" >> flutter/android/gradle.properties
echo "org.gradle.daemon=false" >> flutter/android/gradle.properties
echo "org.gradle.parallel=false" >> flutter/android/gradle.properties

# 4. 增加内存分配
echo "org.gradle.jvmargs=-Xmx2048m" >> flutter/android/gradle.properties
```

### 5.4 Android许可协议问题
```bash
# 解决方案：
flutter doctor --android-licenses
# 输入 'y' 接受所有许可协议
```

### 5.5 Rust编译错误
```bash
# 解决方案：安装必要的构建工具
yum install -y gcc gcc-c++ make

# 设置NDK路径
export NDK_HOME=$ANDROID_HOME/ndk/25.1.8937393
export PATH=$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
```

---

## 🔍 6. 重要文件详解

### 6.1 generated_bridge.dart
- **位置**: `flutter/lib/generated_bridge.dart`
- **作用**: Flutter与Rust的桥接文件
- **重要性**: ⭐⭐⭐⭐⭐ **绝对不可修改！** 已解决PlatformFFI冲突问题

### 6.2 pubspec.yaml
- **位置**: `flutter/pubspec.yaml`
- **作用**: Flutter项目依赖配置
- **关键依赖**: 
  - `flutter_rust_bridge: "1.80.1"`
  - `ffi: ^2.1.0`

---

## 📊 7. 构建验证

### 7.1 构建成功标志
```bash
# Rust库编译成功
ls -la target/aarch64-linux-android/release/librustdesk.so
# 文件大小应该在400-500KB

# Flutter APK构建成功
ls -la flutter/build/app/outputs/flutter-apk/app-release.apk
# 文件大小应该在50-100MB

# 日志中应该看到
# "Built build/app/outputs/flutter-apk/app-release.apk"
```

---

## 🎯 8. 快速开始检查清单

新同事接手项目时，请按照以下清单逐项检查：

- [ ] 1. 克隆项目代码成功
- [ ] 2. Java 17 安装并设置环境变量
- [ ] 3. Android SDK 安装并通过flutter doctor检查
- [ ] 4. Flutter 3.24.5 安装并可正常运行
- [ ] 5. Rust 环境安装并添加Android目标
- [ ] 6. 项目依赖获取成功 (flutter pub get)
- [ ] 7. Rust库编译成功 (librustdesk.so存在)
- [ ] 8. Flutter分析通过 (flutter analyze)
- [ ] 9. APK构建成功
- [ ] 10. APK功能验证通过

**每一项都必须✅才能进行下一步！**

---

## 🚨 特别注意事项

1. **包名规范**: Android包名必须符合Java标识符规范，不能包含数字开头的部分
2. **Kotlin配置**: 必须禁用增量编译和并行执行避免缓存冲突
3. **内存配置**: Gradle需要至少2GB内存进行编译
4. **文件权限**: 确保所有目录具有正确的读写权限

---

最后更新时间: 2024-09-14  
文档版本: v2.1  
维护者: RustDesk开发团队